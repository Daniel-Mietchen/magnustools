<div>

<template id='widar-template'>
<div style='margin-left:5px;margin-right:5px;text-align:center' v-if="loaded">
<div v-if='is_logged_in' style='line-height:1.4em'><span tt="welcome"></span><br/><a class='wikidata' target='_blank' :href='"https://www.wikidata.org/wiki/User:"+encodeURIComponent(userinfo.name.replace(/ /g,"_"))'>{{userinfo.name}}</a></div>
<div v-else><i tt="log_into_widar"></i></div>
</div>
</template>

<script>
var widar ;

Vue.component ( 'widar' , {
	data : function () { return { is_logged_in:false , userinfo:{} , widar_api:'/widar/index.php' , loaded:false , toolname:'' } } ,
	created : function () {
		widar = this ;
		this.checkLogin()
	} ,
	updated : function () { tt.updateInterface(this.$el) } ,
	mounted : function () { tt.updateInterface(this.$el) } ,
	methods : {
		checkLogin : function () {
			var me = this ;
			$.get ( me.widar_api , {
				action:'get_rights',
				botmode:1
			} , function ( d ) {
				me.loaded = true ;
				if ( typeof d.result.query != 'undefined' && typeof d.result.query.userinfo != 'undefined' ) {
					me.is_logged_in = true ;
					me.userinfo = d.result.query.userinfo ;
				} else {
				}
			} , 'json' ) ;
		} ,
		run : function ( params , callback ) {
			var me = this ;
			if ( me.tool != '' && typeof params.tool_hashtag == 'undefined' ) params.tool_hashtag = me.toolname ;
			params.botmode = 1 ;
			$.get ( me.widar_api , params , function ( d ) {
				if ( d.error != 'OK' ) {
					console.log ( params ) ;
					if ( null != d.error.match(/Invalid token/) || null != d.error.match(/happen/) || null != d.error.match(/Problem creating item/) || ( params.action!='create_redirect' && null != d.error.match(/failed/) ) ) {
						console.log ( "ERROR (re-trying)" , params , d ) ;
						setTimeout ( function () { me.run ( params , callback ) } , 500 ) ; // Again
					} else {
						console.log ( "ERROR (aborting)" , params , d ) ;
//						var h = "<li style='color:red'>ERROR (" + params.action + ") : " + d.error + "</li>" ;
//						$('#out ol').append(h) ;
						callback ( d ) ; // Continue anyway
					}
				} else {
					callback ( d ) ;
				}
			} , 'json' ) . fail(function() {
				console.log ( "Again" , params ) ;
				me.run ( params , callback ) ;
			}) ;
		} ,
		newClaimEntity : function ( prop , target ) { // "Pxx" / "Qxx"
			return {
				mainsnak: {
					snaktype : 'value' ,
					property : prop ,
					datavalue : {
						value : {
							'entity-type' : 'item' ,
							'numeric-id' : target.replace(/\D/g,'') ,
							'id' : target
						} ,
						type : 'wikibase-entityid'
					} ,
					datatype : 'wikibase-item'
				} ,
				type : 'statement' ,
				rank : 'normal'
			} ;
		} ,
		getUserName : function () { return this.userinfo.name }
	} ,
	template : '#widar-template'
} ) ;
</script>
</div>